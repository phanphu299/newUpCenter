<div id="CauHoiIndex">
    <v-app>
        <div class="container">
            <div class="col s10 m6 l6">
                <h5 class="breadcrumbs-title">{{ title }}</h5>
            </div>

            <v-card>
                <v-card-title>
                    @if (ViewBag.CanContribute)
                    {

                    <v-btn color="success"
                           v-on:click.stop="dialogImport = true"
                           class="white--text">
                        Thêm Từ Excel
                        <v-icon right dark>attach_file</v-icon>
                    </v-btn>

                    <v-dialog v-model="dialog" persistent max-width="600px">
                        <v-btn color="primary"
                               slot="activator"
                               class="white--text">
                            Thêm Mới
                            <v-icon right dark>add</v-icon>
                        </v-btn>
                        <v-card>
                            <v-card-title>
                                <span class="headline">Thêm Câu Hỏi Mới</span>
                            </v-card-title>
                            <v-card-text>
                                <v-container grid-list-md>
                                    <v-layout wrap>
                                        <v-flex xs12 sm6>
                                            <v-select :items="itemThuThach"
                                                      item-text="name"
                                                      item-value="thuThachId"
                                                      v-model="newItem.thuThach"
                                                      return-object
                                                      label="Chọn Thử Thách *">
                                            </v-select>
                                        </v-flex>

                                        <v-flex xs12 sm6>
                                            <v-select :items="calculateSoCauHoi(newItem.thuThach.soCauHoi)"
                                                      v-model="newItem.stt"
                                                      label="Chọn Số Câu *"
                                                      v-if="newItem.thuThach != ''">
                                            </v-select>
                                        </v-flex>

                                        <v-flex xs12 sm6>
                                            <v-select :items="itemSoDapAn"
                                                      item-text="value"
                                                      item-value="value"
                                                      v-model="soDapAn"
                                                      label="Số Đáp Án *">
                                            </v-select>
                                        </v-flex>

                                        <v-flex xs12 sm6>
                                            <v-select :items="itemSoDapAn.slice(0, soDapAn)"
                                                      item-text="prefix"
                                                      item-value="value"
                                                      v-model="newItem.dapAnDung"
                                                      label="Đáp Án Đúng *">
                                            </v-select>
                                        </v-flex>

                                        <v-flex xs12>
                                            <v-text-field label="Tên Câu Hỏi *" required v-model="newItem.name"></v-text-field>
                                        </v-flex>

                                        <v-flex xs12 sm6 v-for="item in soDapAn" :accesskey="item">
                                            <v-text-field :label="itemSoDapAn[item-1].prefix" required v-model="newItem.dapAns[item-1]"></v-text-field>
                                        </v-flex>


                                    </v-layout>
                                </v-container>
                                <small>* bắt buộc</small><br />
                                <small>** đáp án không được để trống</small>
                                <v-alert v-model="alert"
                                         dismissible
                                         color="warning"
                                         icon="priority_high"
                                         outline>
                                    {{ message }}
                                </v-alert>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="secondary darken-1" flat v-on:click="dialog = false">Đóng</v-btn>
                                <v-btn color="blue darken-1 white--text" v-on:click="onSave(newItem)">Lưu</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                    }

                    <v-spacer></v-spacer>
                    <v-text-field v-model="search"
                                  append-icon="search"
                                  label="Tìm Kiếm"
                                  single-line
                                  hide-details></v-text-field>
                </v-card-title>
                <v-data-table :headers="headers"
                              :items="cauHoiItems"
                              :search="search">
                    <template v-slot:items="props">
                        <td class="justify-center layout px-0">
                            @if (ViewBag.CanContribute)
                            {
                            <v-tooltip top>
                                <template v-slot:activator="{ on }">
                                    <v-btn flat icon slot="activator"
                                           v-on="on"
                                           color="red"
                                           v-on:click.stop="deleteDialog = true"
                                           v-on:click="itemToDelete = props.item">
                                        <v-icon>delete</v-icon>
                                    </v-btn>
                                </template>
                                <strong>Xóa</strong>
                            </v-tooltip>

                            <v-tooltip top>
                                <template v-slot:activator="{ on }">
                                    <v-btn flat icon
                                           color="success"
                                           v-on="on"
                                           v-on:click.stop="dialogDapAn = true"
                                           v-on:click="mappingEditItem(props.item)">
                                        <v-icon>info</v-icon>
                                    </v-btn>
                                </template>
                                <strong>Xem Đáp Án</strong>
                            </v-tooltip>

                            }
                        </td>
                        <td>{{ props.item.tenThuThach }}</td>
                        <td>{{ props.item.stt }}</td>
                        <td>{{ props.item.name }}</td>
                    </template>
                    <v-alert slot="no-results" :value="true" color="error" icon="warning">
                        Không tìm thấy "{{ search }}".
                    </v-alert>
                </v-data-table>
            </v-card>
        </div>

        @*Import Dialog*@
        <v-dialog v-model="dialogImport" persistent max-width="600px">
            <v-card>
                <v-card-title>
                    <span class="headline">Thêm Câu Hỏi Từ Excel</span>
                </v-card-title>
                <v-card-text>
                    <v-container grid-list-md>
                        <v-layout wrap>

                            <v-flex xs12 sm4>
                                <v-select v-model="selectedThuThach"
                                          :items="itemThuThach"
                                          item-text="name"
                                          item-value="thuThachId"
                                          return-object
                                          label="Chọn Thử Thách">
                                </v-select>
                            </v-flex>

                            <v-flex xs12 sm4 v-if="selectedThuThach != ''">
                                <v-btn color="primary"
                                       class="white--text" v-on:click="onExportTemplate">
                                    Download mẫu excel
                                    <v-icon right dark>attach_file</v-icon>
                                </v-btn>
                            </v-flex>

                            <input v-if="selectedThuThach != ''" type="file" id="file" ref="myFiles" class="custom-file-input" />

                        </v-layout>
                    </v-container>
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="secondary darken-1" flat v-on:click="dialogImport = false; selectedThuThach = ''">Đóng</v-btn>
                    <v-btn color="blue darken-1 white--text" v-on:click="onImport">Lưu</v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>

        @*DapAn dialog*@
        <v-dialog v-model="dialogDapAn"
                  max-width="800px">
            <v-card>
                <v-card-title class="cyan darken-1">
                    <span class="headline white--text">{{ itemToEdit.name }}</span>
                </v-card-title>
                <v-card-text>
                    <v-container grid-list-md>
                        <v-layout wrap>
                            <v-flex xs12>
                                <v-list>
                                    <v-list-tile v-for="(item, index) in itemToEdit.dapAns"
                                                 :key="item.name">
                                        <v-list-tile-action>
                                            <b>{{ itemSoDapAn[index].prefix }})</b>
                                        </v-list-tile-action>

                                        <v-list-tile-content>
                                            <v-tooltip top>
                                                <template v-slot:activator="{ on }">
                                                    <v-list-tile-title v-on="on" slot="activator" v-text="item.name"></v-list-tile-title>
                                                </template>
                                                <strong>{{ item.name }}</strong>
                                            </v-tooltip>
                                        </v-list-tile-content>

                                        <v-list-tile-action>
                                            <v-icon v-if="item.isTrue" color="success">check_circle_outline</v-icon>
                                        </v-list-tile-action>
                                    </v-list-tile>

                                </v-list>
                            </v-flex>
                        </v-layout>
                    </v-container>
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="secondary darken-1" flat v-on:click="dialogDapAn = false">Đóng</v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>

        @*DELETE DIALOG*@
        <v-dialog v-model="deleteDialog"
                  width="500">

            <v-card>
                <v-card-title class="headline error lighten-2 white--text"
                              primary-title>
                    Xác Nhận
                </v-card-title>

                <v-card-text>
                    Bạn có chắc xóa '{{ itemToDelete.name }}'?
                </v-card-text>

                <v-divider></v-divider>

                <v-card-actions>
                    <v-spacer></v-spacer>

                    <v-btn color="secondary"
                           flat
                           v-on:click="deleteDialog = false">
                        Đóng
                    </v-btn>

                    <v-btn color="error white--text"
                           v-on:click="onDelete(itemToDelete)">
                        Xóa
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>

        <v-snackbar v-model="snackbar"
                    :color="color"
                    :timeout="timeout"
                    top
                    right>
            {{ messageText }}
            <v-btn dark
                   flat
                   v-on:click="snackbar = false">
                Close
            </v-btn>
        </v-snackbar>
    </v-app>
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="~/js/cauhoiindex.min.js" type="text/javascript"></script>

<style>
    .v-input__slot:before, .v-input__slot:after {
        display: none
    }

    .v-small-dialog a {
        text-decoration-style: dashed;
        text-decoration-line: underline;
        text-decoration-color: #0088cc;
    }
</style>