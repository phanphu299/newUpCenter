<div id="LopHocIndex">
    <v-app>
        <div class="container">
            <div class="col s10 m6 l6">
                <h5 class="breadcrumbs-title">{{ title }}</h5>
            </div>

            <v-card>
                <v-card-title>
                    <v-dialog v-model="dialog" persistent max-width="600px">
                        <v-btn color="primary"
                               slot="activator"
                               class="white--text">
                            Thêm Mới
                            <v-icon right dark>add</v-icon>
                        </v-btn>
                        <v-card>
                            <v-card-title>
                                <span class="headline">Thêm Lớp Học Mới</span>
                            </v-card-title>
                            <v-card-text>
                                <v-container grid-list-md>
                                    <v-layout wrap>

                                        <v-flex xs12 sm4>
                                            <v-text-field label="Tên Lớp Học *" required v-model="newItem.name"></v-text-field>
                                        </v-flex>
                                        <v-flex xs12 sm4>
                                            <v-select :items="itemKhoaHoc"
                                                      item-text="name"
                                                      item-value="khoaHocId"
                                                      v-model="newItem.khoaHoc"
                                                      label="Chọn Khóa Học *">
                                            </v-select>
                                        </v-flex>
                                        <v-flex xs12 sm4>
                                            <v-select :items="itemNgayHoc"
                                                      item-text="name"
                                                      item-value="ngayHocId"
                                                      v-model="newItem.ngayHoc"
                                                      label="Chọn Ngày Học *">
                                            </v-select>
                                        </v-flex>

                                        <v-flex xs12 sm4>
                                            <v-select :items="itemGioHoc"
                                                      :item-text="DisplayGioHoc"
                                                      item-value="gioHocId"
                                                      v-model="newItem.gioHoc"
                                                      label="Chọn Giờ Học *">
                                            </v-select>
                                        </v-flex>
                                        <v-flex xs12 sm4>
                                            <v-select :items="itemHocPhi"
                                                      item-text="gia"
                                                      item-value="hocPhiId"
                                                      v-model="newItem.hocPhi"
                                                      label="Chọn Học Phí *">
                                            </v-select>
                                        </v-flex>
                                        <v-flex xs12 sm4>
                                            <v-menu v-model="isShowDatePicker"
                                                    :close-on-content-click="false"
                                                    :nudge-right="40"
                                                    lazy
                                                    transition="scale-transition"
                                                    offset-y
                                                    full-width
                                                    min-width="290px">
                                                <v-text-field slot="activator"
                                                              v-model="newItem.ngayKhaiGiang"
                                                              label="Ngày Khai Giảng"
                                                              prepend-icon="event"
                                                              readonly></v-text-field>
                                                <v-date-picker locale="vi-vn" v-model="newItem.ngayKhaiGiang" v-on:input="isShowDatePicker = false"></v-date-picker>
                                            </v-menu>
                                        </v-flex>

                                        <v-flex xs12 sm4>
                                            <v-select :items="itemGiaoVien"
                                                      item-text="name"
                                                      item-value="giaoVienId"
                                                      v-model="newItem.giaoVien"
                                                      label="Chọn Giáo Viên Chăm Sóc *">
                                            </v-select>
                                        </v-flex>
                                        <v-flex xs12 sm8>
                                            <v-select v-model="newItem.sach"
                                                      :items="itemSach"
                                                      item-text="name"
                                                      item-value="sachId"
                                                      attach
                                                      chips
                                                      label="Chọn Sách"
                                                      multiple>
                                                <template v-slot:selection="data">
                                                    <v-chip :selected="data.selected"
                                                            color="green"
                                                            text-color="white">
                                                        <strong>{{ data.item.name }}</strong>&nbsp;
                                                        <span>({{ formatNumber(data.item.gia) }})</span>
                                                    </v-chip>
                                                </template>
                                            </v-select>
                                        </v-flex>
                                    </v-layout>
                                </v-container>
                                <small>* bắt buộc</small>
                                <v-alert v-model="alert"
                                         dismissible
                                         color="warning"
                                         icon="priority_high"
                                         outline>
                                    Không được bỏ trống
                                </v-alert>
                            </v-card-text>
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn color="secondary darken-1" flat v-on:click="dialog = false">Đóng</v-btn>
                                <v-btn color="blue darken-1 white--text" v-on:click="onSave">Lưu</v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>

                    <v-spacer></v-spacer>
                    <v-text-field v-model="search"
                                  append-icon="search"
                                  label="Tìm Kiếm"
                                  single-line
                                  hide-details></v-text-field>
                </v-card-title>
                <v-data-table :headers="headers"
                              :items="khoaHocItems"
                              :search="search">
                    <template slot="items" slot-scope="props">
                        <td class="justify-center layout px-0">

                            <v-tooltip top>
                                <template v-slot:activator="{ on }">
                                    <v-btn flat icon slot="activator"
                                           v-on="on"
                                           color="red"
                                           v-on:click.stop="deleteDialog = true"
                                           v-on:click="itemToDelete = props.item">
                                        <v-icon>delete</v-icon>
                                    </v-btn>
                                </template>
                                <strong>Xóa</strong>
                            </v-tooltip>

                            <v-tooltip top>
                                <template v-slot:activator="{ on }">
                                    <v-btn color="primary"
                                           flat icon
                                           v-on="on"
                                           v-on:click.stop="dialogEdit = true"
                                           v-on:click="mappingEditItem(props.item)">
                                        <v-icon>edit</v-icon>
                                    </v-btn>
                                </template>
                                <strong>Sửa</strong>
                            </v-tooltip>

                            <v-tooltip top>
                                <template v-slot:activator="{ on }">
                                    <v-btn flat icon
                                           color="success"
                                           v-on="on"
                                           v-on:click.stop="dialogDiemDanh = true"
                                           v-on:click="mappingDiemDanhItem(props.item)">
                                        <v-icon>info</v-icon>
                                    </v-btn>
                                </template>
                                <strong>Xem Điểm Danh</strong>
                            </v-tooltip>

                        </td>
                        <td>{{ props.item.name }}</td>
                        <td>
                            <v-tooltip top v-if="props.item.sachList.length > 0">
                                <template v-slot:activator="{ on }">
                                    <v-icon color="grey lighten-1" dark v-on="on">library_books</v-icon>
                                </template>
                                <div v-for="sach in props.item.sachList">
                                    <strong>{{ sach.name }}</strong><span> - {{ formatNumber(sach.gia) }}</span>
                                </div>
                            </v-tooltip>
                        </td>
                        <td>{{ props.item.giaoVien }}</td>
                        <td>{{ props.item.khoaHoc }}</td>
                        <td>{{ props.item.ngayHoc }}</td>
                        <td>{{ props.item.gioHocFrom }} - {{ props.item.gioHocTo }}</td>
                        <td>{{ formatNumber(props.item.hocPhi) }}</td>
                        <td><v-switch v-model="props.item.isCanceled" color="success" hide-details v-on:change="onToggleCanceled(props.item.lopHocId)"></v-switch></td>
                        <td><v-switch v-model="props.item.isGraduated" color="success" hide-details v-on:change="onToggleGraduated(props.item.lopHocId)"></v-switch></td>
                        <td>{{ props.item.ngayKhaiGiang }}</td>
                        <td>{{ props.item.ngayKetThuc }}</td>

                        <td>{{ props.item.createdDate }}</td>
                        <td>{{ props.item.createdBy }}</td>
                        <td>{{ props.item.updatedDate }}</td>
                        <td>{{ props.item.updatedBy }}</td>
                    </template>
                    <v-alert slot="no-results" :value="true" color="error" icon="warning">
                        Không tìm thấy "{{ search }}".
                    </v-alert>
                </v-data-table>
            </v-card>
        </div>


        @*Delete Dialog*@
        <v-dialog v-model="deleteDialog"
                  width="500">
            <v-card>
                <v-card-title class="headline error lighten-2 white--text"
                              primary-title>
                    Xác Nhận
                </v-card-title>

                <v-card-text>
                    Bạn có chắc xóa '{{ itemToDelete.name }}'?
                </v-card-text>

                <v-divider></v-divider>

                <v-card-actions>
                    <v-spacer></v-spacer>

                    <v-btn color="secondary"
                           flat
                           v-on:click="deleteDialog = false">
                        Đóng
                    </v-btn>

                    <v-btn color="error white--text"
                           v-on:click="onDelete(itemToDelete)">
                        Xóa
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>


        @*Edit dialog*@
        <v-dialog v-model="dialogEdit"
                  max-width="600px">
            <v-card>
                <v-card-title>
                    <span class="headline">Cập Nhật Lớp Học '{{ itemToEdit.name }}'</span>
                </v-card-title>
                <v-card-text>
                    <v-container grid-list-md>
                        <v-layout wrap>

                            <v-flex xs12 sm4>
                                <v-text-field label="Tên Khóa Học *" required v-model="itemToEdit.name"></v-text-field>
                            </v-flex>
                            <v-flex xs12 sm4>
                                <v-select :items="itemKhoaHoc"
                                          item-text="name"
                                          item-value="khoaHocId"
                                          v-model="itemToEdit.khoaHocId"
                                          label="Chọn Khóa Học *">
                                </v-select>
                            </v-flex>
                            <v-flex xs12 sm4>
                                <v-select :items="itemNgayHoc"
                                          item-text="name"
                                          item-value="ngayHocId"
                                          v-model="itemToEdit.ngayHocId"
                                          label="Chọn Ngày Học *">
                                </v-select>
                            </v-flex>

                            <v-flex xs12 sm4>
                                <v-select :items="itemGioHoc"
                                          :item-text="DisplayGioHoc"
                                          item-value="gioHocId"
                                          v-model="itemToEdit.gioHocId"
                                          label="Chọn Giờ Học *">
                                </v-select>
                            </v-flex>
                            <v-flex xs12 sm4>
                                <v-menu v-model="isShowDatePicker2"
                                        :close-on-content-click="false"
                                        :nudge-right="40"
                                        lazy
                                        transition="scale-transition"
                                        offset-y
                                        full-width
                                        min-width="290px">
                                    <v-text-field slot="activator"
                                                  v-model="itemToEdit.ngayKhaiGiang"
                                                  label="Ngày Khai Giảng"
                                                  prepend-icon="event"
                                                  readonly></v-text-field>
                                    <v-date-picker locale="vi-vn" v-model="itemToEdit.ngayKhaiGiang" v-on:input="isShowDatePicker2 = false"></v-date-picker>
                                </v-menu>
                            </v-flex>
                            <v-flex xs12 sm4>
                                <v-menu v-model="isShowDatePicker3"
                                        :close-on-content-click="false"
                                        :nudge-right="40"
                                        lazy
                                        transition="scale-transition"
                                        offset-y
                                        full-width
                                        min-width="290px">
                                    <v-text-field slot="activator"
                                                  v-model="itemToEdit.ngayKetThuc"
                                                  label="Ngày Kết Thúc"
                                                  prepend-icon="event"
                                                  readonly></v-text-field>
                                    <v-date-picker locale="vi-vn" v-model="itemToEdit.ngayKetThuc" v-on:input="isShowDatePicker3 = false"></v-date-picker>
                                </v-menu>
                            </v-flex>

                            <v-flex xs12 sm4>
                                <v-select :items="itemHocPhi"
                                          item-text="gia"
                                          item-value="hocPhiId"
                                          v-model="itemToEdit.hocPhiId"
                                          label="Chọn Học Phí *">
                                </v-select>
                            </v-flex>

                            <v-flex xs12 sm4>
                                <v-select :items="itemGiaoVien"
                                          item-text="name"
                                          item-value="giaoVienId"
                                          v-model="itemToEdit.giaoVienId"
                                          label="Chọn Giáo Viên *">
                                </v-select>
                            </v-flex>
                            <v-flex xs12 sm12>
                                <v-select v-model="itemToEdit.sachIds"
                                          :items="itemSach"
                                          item-text="name"
                                          item-value="sachId"
                                          attach
                                          chips
                                          label="Chọn Sách"
                                          multiple>
                                    <template v-slot:selection="data">
                                        <v-chip :selected="data.selected"
                                                color="green"
                                                text-color="white">
                                            <strong>{{ data.item.name }}</strong>&nbsp;
                                            <span>({{ formatNumber(data.item.gia) }})</span>

                                        </v-chip>
                                    </template>
                                </v-select>
                            </v-flex>
                        </v-layout>
                    </v-container>
                    <small>* bắt buộc</small>
                    <v-alert v-model="alertEdit"
                             dismissible
                             color="warning"
                             icon="priority_high"
                             outline>
                        Không được bỏ trống
                    </v-alert>
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="secondary darken-1" flat v-on:click="dialogEdit = false">Đóng</v-btn>
                    <v-btn color="blue darken-1 white--text" v-on:click="onUpdate(itemToEdit)">Lưu</v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>

        @*DiemDanh Dialog*@
        <v-dialog v-model="dialogDiemDanh" persistent max-width="600px">
            <v-card>
                <v-card-title>
                    <span class="headline">Lịch Sử Điểm Danh Lớp '{{ itemToDiemDanh.name }}'</span>
                </v-card-title>

                <v-card-text>
                        
                        <v-layout wrap>
                            <v-flex xs12 sm4>
                                <v-select :items="itemThang"
                                          v-model="selectedThang"
                                          chips
                                          label="Chọn Tháng"></v-select>
                            </v-flex>

                            <v-flex xs12 sm4>
                                <v-select :items="itemNam"
                                          v-model="selectedNam"
                                          chips
                                          label="Chọn Năm"></v-select>
                            </v-flex>

                            <v-flex xs12 sm4>
                                <v-btn color="primary" v-on:click="onTinhDiemDanh">Tìm</v-btn>
                            </v-flex>
                        </v-layout>

                        <v-container fluid v-if="diemDanhItems.length > 0">
                            <v-layout wrap>
                                <v-flex>
                                    <table class="table" style="border: 1px solid black;">
                                        <thead style="background-color: #dee2e6;">
                                            <tr style="border: 1px solid black;">
                                                <th style="border: 1px solid black;">Học Viên</th>
                                                <th style="border: 1px solid black;" v-for="(column, index) in soNgayHoc" :key="index"> {{ column }}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="border: 1px solid black;" v-for="(item, index) in diemDanhItems" :key="index">
                                                <td style="border: 1px solid black;">{{ item.label }}</td>
                                                <td style="border: 1px solid black;" v-for="(column, indexColumn) in soNgayHoc" :key="indexColumn">
                                                    <span v-for="(content, indexSpan) in item.thongKeDiemDanh" :key="indexSpan">
                                                        <i v-if="content.day == column && content.isOff == false">x</i>
                                                        <i v-else-if="content.day == column && content.isOff == true && content.duocNghi == true">off</i>
                                                        <i v-else-if="content.day == column && content.isOff == true && content.duocNghi == null"></i>
                                                    </span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </v-flex>
                            </v-layout>
                        </v-container>

                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="secondary darken-1" flat v-on:click="dialogDiemDanh = false; diemDanhItems = [];">Đóng</v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>

        <v-snackbar v-model="snackbar"
                    :color="color"
                    :timeout="timeout"
                    top
                    right>
            {{ messageText }}
            <v-btn dark
                   flat
                   v-on:click="snackbar = false">
                Close
            </v-btn>
        </v-snackbar>
    </v-app>
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="~/js/lophocindex.js" type="text/javascript"></script>

<style>
    .v-input__slot:before, .v-input__slot:after {
        display: none
    }

    .v-small-dialog a {
        text-decoration-style: dashed;
        text-decoration-line: underline;
        text-decoration-color: #0088cc;
    }

    td, th {
        padding: unset;
    }
</style>