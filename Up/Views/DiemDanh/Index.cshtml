<div id="DiemDanhIndex">
    <v-app>
        <div class="container">
            <div class="col s10 m6 l6">
                <h5 class="breadcrumbs-title">{{ title }}</h5>
            </div>

            <v-card>
                <v-card-title>
                    <v-layout wrap>
                        <v-flex xs12 sm3>
                            <v-select v-model="selectedLopHoc"
                                      :items="itemLopHoc"
                                      item-text="name"
                                      item-value="lopHocId"
                                      chips
                                      label="Chọn Lớp Học"
                                      v-on:change="onTinhDiemDanh">
                                <template v-slot:selection="data">
                                    <v-chip :selected="data.selected"
                                            color="green"
                                            text-color="white">
                                        <span>{{ data.item.name }}</span>
                                    </v-chip>
                                </template>
                            </v-select>
                        </v-flex>

                        <v-flex xs12 sm3>
                            <v-select :items="itemThang"
                                      v-model="selectedThang"
                                      chips
                                      label="Chọn Tháng"
                                      v-on:change="onTinhDiemDanh"></v-select>
                        </v-flex>

                        <v-flex xs12 sm3>
                            <v-select :items="itemNam"
                                      v-model="selectedNam"
                                      chips
                                      label="Chọn Năm"
                                      v-on:change="onTinhDiemDanh"></v-select>
                        </v-flex>

                        <v-flex xs12 sm3>
                            <v-menu v-model="isShowDatePicker"
                                    :close-on-content-click="false"
                                    :nudge-right="40"
                                    lazy
                                    transition="scale-transition"
                                    offset-y
                                    full-width
                                    v-if="diemDanhItems.length > 0"
                                    min-width="290px">
                                <v-text-field slot="activator"
                                              v-model="ngayDiemDanh"
                                              label="Ngày Điểm Danh"
                                              prepend-icon="event"
                                              readonly></v-text-field>
                                <v-date-picker locale="vi-vn" v-model="ngayDiemDanh" v-on:input="isShowDatePicker = false"></v-date-picker>
                            </v-menu>
                        </v-flex>

                        @if (ViewBag.CanContribute)
                        {
                            <v-flex xs12 sm2 class="text-xs-center">
                                <v-btn v-if="diemDanhItems.length > 0"
                                       color="info"
                                       v-on:click="DiemDanhCaLop()">
                                    Có Mặt Cả Lớp
                                </v-btn>
                            </v-flex>
                            <v-flex xs12 sm2 class="text-xs-center">
                                <v-btn v-if="diemDanhItems.length > 0"
                                       color="error"
                                       v-on:click="LopNghi()">
                                    Lớp Nghỉ
                                </v-btn>
                            </v-flex>

                            <v-flex xs12 sm2 class="text-xs-center">
                                <v-btn v-if="diemDanhItems.length > 0"
                                       color="warning"
                                       v-on:click="UndoLopNghi()">
                                    Hoàn Tác Cả Lớp
                                </v-btn>
                            </v-flex>

                            <v-flex xs12 sm2 class="text-xs-center">
                            </v-flex>

                            <v-flex xs12 sm2 class="text-xs-center">
                                <v-dialog v-model="dialog" persistent max-width="600px" v-if="diemDanhItems.length > 0">
                                    <v-btn color="success"
                                           slot="activator"
                                           class="white--text">
                                        Chọn Học Viên OFF
                                    </v-btn>
                                    <v-card>
                                        <v-card-title>
                                            <span class="headline">Chon Học Viên OFF ngày {{ngayDiemDanh}}</span>
                                        </v-card-title>
                                        <v-card-text>
                                            <v-container grid-list-md>
                                                <v-layout wrap>
                                                    <v-select v-model="selectedHocViens"
                                                              :items="diemDanhItems"
                                                              item-text="label"
                                                              item-value="hocVienId"
                                                              chips
                                                              label="Chọn Học Viên"
                                                              multiple>
                                                        <template v-slot:selection="data">
                                                            <v-chip :selected="data.selected"
                                                                    color="green"
                                                                    text-color="white">
                                                                <span>{{ data.item.label }}</span>
                                                            </v-chip>
                                                        </template>
                                                    </v-select>
                                                </v-layout>
                                            </v-container>
                                        </v-card-text>
                                        <v-card-actions>
                                            <v-spacer></v-spacer>
                                            <v-btn color="secondary darken-1" flat v-on:click="selectedHocViens = []; dialog = false">Đóng</v-btn>
                                            <v-btn color="blue darken-1 white--text" v-on:click="onSaveHocVienOff">Lưu</v-btn>
                                        </v-card-actions>
                                    </v-card>
                                </v-dialog>
                            </v-flex>

                            <v-flex xs12 sm2 class="text-xs-center">
                                <v-dialog v-model="dialogHoanTac" persistent max-width="600px" v-if="diemDanhItems.length > 0">
                                    <v-btn color="yellow darken-3"
                                           slot="activator"
                                           class="white--text">
                                        Chọn Học Viên Hoàn Tác
                                    </v-btn>
                                    <v-card>
                                        <v-card-title>
                                            <span class="headline">Chon Học Viên Hoàn Tác ngày {{ngayDiemDanh}}</span>
                                        </v-card-title>
                                        <v-card-text>
                                            <v-container grid-list-md>
                                                <v-layout wrap>
                                                    <v-select v-model="selectedHocViens"
                                                              :items="diemDanhItems"
                                                              item-text="label"
                                                              item-value="hocVienId"
                                                              chips
                                                              label="Chọn Học Viên"
                                                              multiple>
                                                        <template v-slot:selection="data">
                                                            <v-chip :selected="data.selected"
                                                                    color="green"
                                                                    text-color="white">
                                                                <span>{{ data.item.label }}</span>
                                                            </v-chip>
                                                        </template>
                                                    </v-select>
                                                </v-layout>
                                            </v-container>
                                        </v-card-text>
                                        <v-card-actions>
                                            <v-spacer></v-spacer>
                                            <v-btn color="secondary darken-1" flat v-on:click="selectedHocViens = []; dialogHoanTac = false">Đóng</v-btn>
                                            <v-btn color="blue darken-1 white--text" v-on:click="onSaveHocVienHoanTac">Lưu</v-btn>
                                        </v-card-actions>
                                    </v-card>
                                </v-dialog>
                            </v-flex>
                        }

                    </v-layout>
                </v-card-title>
                <span v-if="diemDanhItems.length > 0" style="color:red; margin-left: 20px">* Chọn Ngày Trước</span>
                <v-container fluid v-if="diemDanhItems.length > 0">
                    <v-layout wrap>
                        <v-flex>
                            <div style="overflow-x:auto;">
                                <table class="table table-condensed table-hover table-bordered" style="border: 1px solid #ddd;">
                                    <thead style="background-color: orange;">
                                        <tr style="border: 1px solid #ddd;">
                                            <th style="border: 1px solid #ddd;">STT</th>
                                            <th style="border: 1px solid #ddd;">Học Viên</th>
                                            <th style="border: 1px solid #ddd; text-align: center" v-for="(column, index) in soNgayHoc" :key="index"> {{ column }}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="border: 1px solid #ddd;" v-for="(item, index) in diemDanhItems" :key="index">
                                            <td style="border: 1px solid #ddd;">{{ (index + 1) }}</td>
                                            <td style="border: 1px solid #ddd;">{{ item.label }}</td>
                                            <td style="border: 1px solid #ddd; text-align: center" v-for="(column, indexColumn) in soNgayHoc" :key="indexColumn">
                                                @*phai~ dao~ isOff de ko sinh loi v-switch*@
                                                <span v-for="(content, indexSpan) in item.thongKeDiemDanh" :key="indexSpan">
                                                    <span v-if="item.ngayBatDau_Year < selectedNam">
                                                        <i v-if="content.day == column && content.isOff == false && content.duocNghi == false">
                                                            @if (ViewBag.CanContribute)
                                                            {
                                                                <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                            }
                                                            else
                                                            {
                                                                <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" readonly v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                            }
                                                        </i>
                                                        <i v-else-if="content.day == column && content.isOff == false && content.duocNghi == true">
                                                            OFF
                                                        </i>
                                                        <i v-else-if="content.day == column && content.isOff == true && content.duocNghi == false">
                                                            @if (ViewBag.CanContribute)
                                                            {
                                                                <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                            }
                                                            else
                                                            {
                                                                <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" readonly color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                            }
                                                        </i>
                                                    </span>
                                                    <span v-else-if="item.ngayBatDau_Year == selectedNam">
                                                        <span v-if="item.ngayBatDau_Month < selectedThang">
                                                            <i v-if="content.day == column && content.isOff == false && content.duocNghi == false">
                                                                @if (ViewBag.CanContribute)
                                                                {
                                                                    <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                }
                                                                else
                                                                {
                                                                    <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" readonly color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                }
                                                            </i>
                                                            <i v-else-if="content.day == column && content.isOff == false && content.duocNghi == true">
                                                                OFF
                                                            </i>
                                                            <i v-else-if="content.day == column && content.isOff == true && content.duocNghi == false">
                                                                @if (ViewBag.CanContribute)
                                                                {
                                                                    <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                }
                                                                else
                                                                {
                                                                    <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" readonly v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                }

                                                            </i>
                                                        </span>
                                                        <span v-else-if="item.ngayBatDau_Month == selectedThang">
                                                            <span v-if="item.ngayBatDau_Day < column">
                                                                <i v-if="content.day == column && content.isOff == false && content.duocNghi == false">
                                                                    @if (ViewBag.CanContribute)
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }
                                                                    else
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" readonly v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }

                                                                </i>
                                                                <i v-else-if="content.day == column && content.isOff == false && content.duocNghi == true">
                                                                    OFF
                                                                </i>
                                                                <i v-else-if="content.day == column && content.isOff == true && content.duocNghi == false">
                                                                    @if (ViewBag.CanContribute)
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }
                                                                    else
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" readonly v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }

                                                                </i>
                                                            </span>
                                                            <span v-else-if="item.ngayBatDau_Day == column">
                                                                <i v-if="content.day == column && content.isOff == false && content.duocNghi == false">
                                                                    @if (ViewBag.CanContribute)
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }
                                                                    else
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" readonly color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }

                                                                </i>
                                                                <i v-else-if="content.day == column && content.isOff == false && content.duocNghi == true">
                                                                    OFF
                                                                </i>
                                                                <i v-else-if="content.day == column && content.isOff == true && content.duocNghi == false">
                                                                    @if (ViewBag.CanContribute)
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }
                                                                    else
                                                                    {
                                                                        <v-switch v-if="item.ngayKetThuc_Year === 0 || item.ngayKetThuc_Year > selectedNam || (item.ngayKetThuc_Year !== 0 && item.ngayKetThuc_Year == selectedNam && (item.ngayKetThuc_Month > selectedThang || (item.ngayKetThuc_Month == selectedThang && item.ngayKetThuc_Day > column)))" v-model="content.isOff" readonly color="success" v-on:change="onDiemDanhNew(item.hocVienId, column, content.isOff)" hide-details></v-switch>
                                                                    }

                                                                </i>
                                                            </span>
                                                            <span v-else>
                                                            </span>
                                                        </span>
                                                        <span v-else>
                                                        </span>
                                                    </span>
                                                    <span v-else></span>
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </v-flex>
                    </v-layout>
                </v-container>

            </v-card>
        </div>

        <v-snackbar v-model="snackbar"
                    :color="color"
                    :timeout="timeout"
                    top
                    right>
            {{ messageText }}
            <v-btn dark
                   flat
                   v-on:click="snackbar = false">
                Close
            </v-btn>
        </v-snackbar>
    </v-app>
</div>

<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="~/js/diemdanhindex.js" type="text/javascript"></script>

<style>
    .v-input__slot:before, .v-input__slot:after {
        display: none
    }

    .v-small-dialog a {
        text-decoration-style: dashed;
        text-decoration-line: underline;
        text-decoration-color: #0088cc;
    }

    td, th {
        padding: unset;
    }

    .table-bordered {
        border: 1px solid #ddd;
    }

    .table {
        width: 100%;
        max-width: 100%;
        margin-bottom: 20px;
    }

    table {
        background-color: transparent;
    }

    table {
        border-collapse: collapse;
        border-spacing: 0;
    }

    .table > caption + thead > tr:first-child > td, .table > caption + thead > tr:first-child > th, .table > colgroup + thead > tr:first-child > td, .table > colgroup + thead > tr:first-child > th, .table > thead:first-child > tr:first-child > td, .table > thead:first-child > tr:first-child > th {
        border-top: 0;
    }

    .table-bordered > thead > tr > td, .table-bordered > thead > tr > th {
        border-bottom-width: 2px;
    }

    .table-bordered > tbody > tr > td, .table-bordered > tbody > tr > th, .table-bordered > tfoot > tr > td, .table-bordered > tfoot > tr > th, .table-bordered > thead > tr > td, .table-bordered > thead > tr > th {
        border: 1px solid #ddd;
    }

    .table-condensed > tbody > tr > td, .table-condensed > tbody > tr > th, .table-condensed > tfoot > tr > td, .table-condensed > tfoot > tr > th, .table-condensed > thead > tr > td, .table-condensed > thead > tr > th {
        padding: 5px;
    }

    .table > thead > tr > th {
        vertical-align: bottom;
        border-bottom: 2px solid #ddd;
    }

    .table > tbody > tr > td, .table > tbody > tr > th, .table > tfoot > tr > td, .table > tfoot > tr > th, .table > thead > tr > td, .table > thead > tr > th {
        padding: 8px;
        line-height: 1.42857143;
        vertical-align: top;
        border-top: 1px solid #ddd;
    }

    .v-input--selection-controls {
        margin-top: 0px;
        width: 0px;
    }
</style>