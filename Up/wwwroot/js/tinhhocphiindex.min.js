var vue=new Vue({el:"#HocPhiIndex",data:{title:"Tính Học Phí",messageText:"",color:"",timeout:3e3,snackbar:!1,deleteDialog:!1,dialog:!1,selectedLopHoc:"",selectedThang:"",selectedNam:"",selectedHocPhi:"",selectedLastThang:"",selectedLastHocPhi:"",selectedLastLopHoc:"",itemThang:["1","2","3","4","5","6","7","8","9","10","11","12"],itemKhuyenMai:[5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100],itemNam:[(new Date).toISOString().substr(0,4)-2,(new Date).toISOString().substr(0,4)-1,(new Date).toISOString().substr(0,4)-0,parseInt((new Date).toISOString().substr(0,4))+1],itemLopHoc:[],itemSach:[],itemHocPhi:[],tongNgayHoc:0,tongNgayDuocNghi:0,tongHocPhi:0,hocPhiMoiNgay:0,hocVienList:[],headers:[{text:"Tên HV",align:"left",sortable:!0},{text:"Học Phí Tháng",align:"left",sortable:!0,class:"red-header"},{text:"Nợ",align:"left",sortable:!0},{text:"Tài Liệu",align:"left",sortable:!0},{text:"Khuyến Mãi",align:"left",sortable:!0},{text:"Bonus",align:"left",sortable:!0},{text:"Khoảng Trừ Khác",align:"left",sortable:!0},{text:"Ghi Chú",align:"left",sortable:!0},{text:"Action",align:"left",sortable:!1}]},async beforeCreate(){let e=this;await axios.get("/LopHoc/GetAvailableLopHocAsync").then(function(o){e.itemLopHoc=o.data}).catch(function(e){console.log(e)}),await axios.get("/Category/GetSachAsync").then(function(o){e.itemSach=o.data}).catch(function(e){console.log(e)}),await axios.get("/Category/GetHocPhiAsync").then(function(o){e.itemHocPhi=o.data}).catch(function(e){console.log(e)})},computed:{total(){let e=0;for(let o of this.hocVienList)e+=1*o.hocPhiMoi;return e}},methods:{async onchangeKhuyenMai(e,o){if(void 0===e&&(e=0),o.hocPhiMoi=o.hocPhiFixed+o.tienNo-o.hocPhiFixed*e/100,o.hocPhiMoi=1e4*Math.ceil(o.hocPhiMoi/1e4),null!==o.lastGiaSach)for(let e=0;e<o.lastGiaSach.length;e++)o.hocPhiMoi=o.hocPhiMoi+1*o.lastGiaSach[e].gia;o.lastBonus>0&&(o.hocPhiMoi=o.hocPhiMoi+1*o.lastBonus),o.lastMinus>0&&(o.hocPhiMoi=o.hocPhiMoi-1*o.lastMinus)},async onBonusHocPhi(e,o){o.lastBonus>0&&(o.hocPhiMoi=o.hocPhiMoi-1*o.lastBonus),o.hocPhiMoi=o.hocPhiMoi+1*e,o.lastBonus=e},async onMinusHocPhi(e,o){o.lastMinus>0&&(o.hocPhiMoi=o.hocPhiMoi+1*o.lastMinus),o.hocPhiMoi=o.hocPhiMoi-1*e,o.lastMinus=e},async onchangeSach(e,o){if(e.length>0){if(null!==o.lastGiaSach)for(let e=0;e<o.lastGiaSach.length;e++)o.hocPhiMoi=o.hocPhiMoi-1*o.lastGiaSach[e].gia;o.lastGiaSach=e;for(let t=0;t<e.length;t++)o.hocPhiMoi=o.hocPhiMoi+1*e[t].gia}else{for(let e=0;e<o.lastGiaSach.length;e++)o.hocPhiMoi=o.hocPhiMoi-1*o.lastGiaSach[e].gia;o.lastGiaSach=e}},async onTinhTien(){let e=this;e.hocVienList=[],this.selectedThang!==this.selectedLastThang&&(this.selectedNam="",this.selectedLastThang=this.selectedThang,this.selectedHocPhi="",this.selectedLastHocPhi=""),this.selectedLopHoc!==this.selectedLastLopHoc&&(this.selectedNam="",this.selectedLastLopHoc=this.selectedLopHoc,this.selectedHocPhi="",this.selectedLastHocPhi=""),""!==this.selectedLopHoc&&""!==this.selectedNam&&""!==this.selectedThang&&await axios.get("/LopHoc/GetAvailableLopHocWithTimeAsync?Thang="+this.selectedThang+"&Nam="+this.selectedNam).then(function(o){e.itemLopHoc=o.data;for(let o=0;o<e.itemLopHoc.length;o++)e.selectedLopHoc.lopHocId===e.itemLopHoc[o].lopHocId&&(e.selectedLopHoc=e.itemLopHoc[o])}).catch(function(e){console.log(e)}),this.selectedHocPhi===this.selectedLastHocPhi&&""!==this.selectedLopHoc&&""!==this.selectedNam&&""!==this.selectedThang&&null!==this.selectedLopHoc.hocPhi&&(this.selectedHocPhi=this.selectedLopHoc.hocPhi,this.selectedLastHocPhi=this.selectedLopHoc.hocPhi),""!==this.selectedLopHoc&&""!==this.selectedNam&&""!==this.selectedThang&&""!==this.selectedHocPhi&&(""===this.khuyenMai&&(this.khuyenMai=0),await axios.get("/HocPhi/GetTinhHocPhiAsync?LopHocId="+this.selectedLopHoc.lopHocId+"&Month="+this.selectedThang+"&Year="+this.selectedNam+"&HocPhi="+this.selectedHocPhi.gia+"&HocPhiId="+this.selectedHocPhi.hocPhiId).then(function(o){e.tongNgayHoc=o.data.soNgayHoc,e.tongNgayDuocNghi=o.data.soNgayDuocNghi,e.tongHocPhi=o.data.hocPhi,e.hocVienList=o.data.hocVienList,e.hocPhiMoiNgay=o.data.hocPhiMoiNgay;for(let o=0;o<e.hocVienList.length;o++)e.hocVienList[o].year=e.selectedNam,e.hocVienList[o].month=e.selectedThang,e.hocVienList[o].lopHocId=e.selectedLopHoc.lopHocId}).catch(function(e){console.log(e)}))},forceFileDownload(e){const o=window.URL.createObjectURL(new Blob([e.data])),t=document.createElement("a");t.href=o,t.setAttribute("download","hocphi_"+this.selectedLopHoc.name+"_T"+this.selectedThang+"-"+this.selectedNam+".xlsx"),document.body.appendChild(t),t.click()},async onExport(){let e=this;await axios({url:"/HocPhi/Export",method:"put",responseType:"blob",data:{HocVienList:e.hocVienList,LopHocId:e.selectedLopHoc.lopHocId,month:e.selectedThang,year:e.selectedNam}}).then(function(o){e.forceFileDownload(o)}).catch(function(e){console.log(e)})},formatNumber:e=>e.toLocaleString("it-IT",{style:"currency",currency:"VND"}),async onLuu(e){let o=this;if(isNaN(e.hocPhiMoi))this.messageText="Học phí chỉ được nhập số",this.snackbar=!0,this.color="error";else{let t=null!==e.giaSach?e.giaSach.map(e=>e.sachId):[];(isNaN(e.bonus)||""===e.bonus)&&(e.bonus=0),(isNaN(e.minus)||""===e.minus)&&(e.minus=0),await axios({method:"post",url:"/HocPhi/LuuDoanhThu_HocPhiAsync",data:{LopHocId:this.selectedLopHoc.lopHocId,HocVienId:e.hocVienId,HocPhi:e.hocPhiMoi,month:this.selectedThang,year:this.selectedNam,Bonus:e.bonus,Minus:e.minus,KhuyenMai:e.khuyenMai,GhiChu:e.ghiChu,SachIds:t}}).then(function(t){console.log(t),"OK"===t.data.status?(o.snackbar=!0,o.messageText="Lưu Doanh Thu thành công !!!",o.color="success",e.daDongHocPhi=!0,e.daNo=!1):(o.snackbar=!0,o.messageText=t.data.message,o.color="error")}).catch(function(e){console.log(e),o.snackbar=!0,o.messageText="Lưu Doanh Thu lỗi: "+e,o.color="error"})}},async onNo(e){let o=this;if(isNaN(e.hocPhiMoi))this.messageText="Học phí chỉ được nhập số",this.snackbar=!0,this.color="error";else{let t=null!==e.giaSach?e.giaSach.map(e=>e.sachId):[];await axios({method:"post",url:"/HocPhi/LuuNo_HocPhiAsync",data:{LopHocId:this.selectedLopHoc.lopHocId,HocVienId:e.hocVienId,HocPhi:e.hocPhiMoi,month:this.selectedThang,year:this.selectedNam,Bonus:e.bonus,Minus:e.minus,KhuyenMai:e.khuyenMai,GhiChu:e.ghiChu,SachIds:t}}).then(function(t){console.log(t),"OK"===t.data.status?(o.snackbar=!0,o.messageText="Lưu Nợ thành công !!!",o.color="success",e.daDongHocPhi=!1,e.daNo=!0):(o.snackbar=!0,o.messageText=t.data.message,o.color="error")}).catch(function(e){console.log(e),o.snackbar=!0,o.messageText="Lưu Nợ lỗi: "+e,o.color="error"})}},async onLuuNhap(){let e=this;await axios({method:"post",url:"/HocPhi/LuuNhap_HocPhiAsync",data:{models:e.hocVienList}}).then(function(o){console.log(o),"OK"===o.data.status?(e.snackbar=!0,e.messageText="Lưu Bảng Tính thành công !!!",e.color="success"):(e.snackbar=!0,e.messageText=o.data.message,e.color="error")}).catch(function(o){console.log(o),e.snackbar=!0,e.messageText="Lưu Bảng Tính lỗi: "+o,e.color="error"})},async onUndo(e){let o=this;await axios.get("/HocPhi/UndoAsync?LopHocId="+this.selectedLopHoc.lopHocId+"&HocVienId="+e.hocVienId+"&Month="+this.selectedThang+"&Year="+this.selectedNam).then(function(t){"OK"===t.data.status?(o.snackbar=!0,o.messageText="Undo thành công !!!",o.color="success",e.daDongHocPhi=!1,e.daNo=!1):(o.snackbar=!0,o.messageText=t.data.message,o.color="error")}).catch(function(e){console.log(e),o.snackbar=!0,o.messageText="Undo lỗi: "+e,o.color="error"})}}});