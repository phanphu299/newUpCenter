var vue=new Vue({el:"#HocPhiIndex",data:{title:"Tính Học Phí",messageText:"",color:"",timeout:3e3,snackbar:!1,deleteDialog:!1,dialog:!1,selectedLopHoc:"",selectedThang:"",selectedNam:"",selectedHocPhi:"",itemThang:["1","2","3","4","5","6","7","8","9","10","11","12"],itemKhuyenMai:[5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100],itemNam:[(new Date).toISOString().substr(0,4)-2,(new Date).toISOString().substr(0,4)-1,(new Date).toISOString().substr(0,4)-0],itemLopHoc:[],itemSach:[],itemHocPhi:[],tongNgayHoc:0,tongNgayDuocNghi:0,tongHocPhi:0,hocPhiMoiNgay:0,hocVienList:[],headers:[{text:"Tên HV",align:"left",sortable:!0},{text:"Học Phí Tháng",align:"left",sortable:!0,class:"red-header"},{text:"Nợ",align:"left",sortable:!0},{text:"Tài Liệu",align:"left",sortable:!0},{text:"Khuyến Mãi",align:"left",sortable:!0},{text:"Bonus",align:"left",sortable:!0},{text:"Khoảng Trừ Khác",align:"left",sortable:!0},{text:"Ghi Chú",align:"left",sortable:!0},{text:"Action",align:"left",sortable:!1}]},async beforeCreate(){let o=this;await axios.get("/LopHoc/GetAvailableLopHocAsync").then(function(e){o.itemLopHoc=e.data}).catch(function(o){console.log(o)}),await axios.get("/Category/GetSachAsync").then(function(e){o.itemSach=e.data}).catch(function(o){console.log(o)}),await axios.get("/Category/GetHocPhiAsync").then(function(e){o.itemHocPhi=e.data}).catch(function(o){console.log(o)})},computed:{total(){let o=0;for(let e of this.hocVienList)o+=1*e.hocPhiMoi;return o}},methods:{async onchangeKhuyenMai(o,e){if(void 0===o&&(o=0),e.hocPhiMoi=e.hocPhiFixed-e.hocPhiFixed*o/100,e.hocPhiMoi=1e4*Math.ceil(e.hocPhiMoi/1e4),null!==e.lastGiaSach)for(let o=0;o<e.lastGiaSach.length;o++)e.hocPhiMoi=e.hocPhiMoi+1*e.lastGiaSach[o].gia;e.lastBonus>0&&(e.hocPhiMoi=e.hocPhiMoi+1*e.lastBonus),e.lastMinus>0&&(e.hocPhiMoi=e.hocPhiMoi-1*e.lastMinus)},async onBonusHocPhi(o,e){e.lastBonus>0&&(e.hocPhiMoi=e.hocPhiMoi-1*e.lastBonus),e.hocPhiMoi=e.hocPhiMoi+1*o,e.lastBonus=o},async onMinusHocPhi(o,e){e.lastMinus>0&&(e.hocPhiMoi=e.hocPhiMoi+1*e.lastMinus),e.hocPhiMoi=e.hocPhiMoi-1*o,e.lastMinus=o},async onchangeSach(o,e){if(o.length>0){if(null!==e.lastGiaSach)for(let o=0;o<e.lastGiaSach.length;o++)e.hocPhiMoi=e.hocPhiMoi-1*e.lastGiaSach[o].gia;e.lastGiaSach=o;for(let t=0;t<o.length;t++)e.hocPhiMoi=e.hocPhiMoi+1*o[t].gia}else{for(let o=0;o<e.lastGiaSach.length;o++)e.hocPhiMoi=e.hocPhiMoi-1*e.lastGiaSach[o].gia;e.lastGiaSach=o}},async onTinhTien(){let o=this;""!==this.selectedLopHoc&&""!==this.selectedNam&&""!==this.selectedThang&&""!==this.selectedHocPhi&&(""===this.khuyenMai&&(this.khuyenMai=0),await axios.get("/HocPhi/GetTinhHocPhiAsync?LopHocId="+this.selectedLopHoc.lopHocId+"&Month="+this.selectedThang+"&Year="+this.selectedNam+"&HocPhi="+this.selectedHocPhi).then(function(e){o.tongNgayHoc=e.data.soNgayHoc,o.tongNgayDuocNghi=e.data.soNgayDuocNghi,o.tongHocPhi=e.data.hocPhi,o.hocVienList=e.data.hocVienList,o.hocPhiMoiNgay=e.data.hocPhiMoiNgay;for(let e=0;e<o.hocVienList.length;e++)o.hocVienList[e].year=o.selectedNam,o.hocVienList[e].month=o.selectedThang,o.hocVienList[e].lopHocId=o.selectedLopHoc.lopHocId}).catch(function(o){console.log(o)}))},forceFileDownload(o){const e=window.URL.createObjectURL(new Blob([o.data])),t=document.createElement("a");t.href=e,t.setAttribute("download","hocphi_"+this.selectedLopHoc.name+"_T"+this.selectedThang+"-"+this.selectedNam+".xlsx"),document.body.appendChild(t),t.click()},async onExport(){let o=this;await axios({url:"/HocPhi/Export",method:"put",responseType:"blob",data:{HocVienList:o.hocVienList,LopHocId:o.selectedLopHoc.lopHocId,month:o.selectedThang,year:o.selectedNam}}).then(function(e){o.forceFileDownload(e)}).catch(function(o){console.log(o)})},formatNumber:o=>o.toLocaleString("it-IT",{style:"currency",currency:"VND"}),async onLuu(o){let e=this;if(isNaN(o.hocPhiMoi))this.messageText="Học phí chỉ được nhập số",this.snackbar=!0,this.color="error";else{let t=null!==o.giaSach?o.giaSach.map(o=>o.sachId):[];await axios({method:"post",url:"/HocPhi/LuuDoanhThu_HocPhiAsync",data:{LopHocId:this.selectedLopHoc.lopHocId,HocVienId:o.hocVienId,HocPhi:o.hocPhiMoi,month:this.selectedThang,year:this.selectedNam,Bonus:o.bonus,Minus:o.minus,KhuyenMai:o.khuyenMai,GhiChu:o.ghiChu,SachIds:t,No:o.tienNo}}).then(function(t){console.log(t),"OK"===t.data.status?(e.snackbar=!0,e.messageText="Lưu Doanh Thu thành công !!!",e.color="success",o.daDongHocPhi=!0,o.daNo=!1):(e.snackbar=!0,e.messageText=t.data.message,e.color="error")}).catch(function(o){console.log(o),e.snackbar=!0,e.messageText="Lưu Doanh Thu lỗi: "+o,e.color="error"})}},async onNo(o){let e=this;isNaN(o.hocPhiMoi)?(this.messageText="Học phí chỉ được nhập số",this.snackbar=!0,this.color="error"):await axios({method:"post",url:"/HocPhi/LuuNo_HocPhiAsync",data:{LopHocId:this.selectedLopHoc.lopHocId,HocVienId:o.hocVienId,TienNo:o.hocPhiMoi,month:this.selectedThang,year:this.selectedNam}}).then(function(t){console.log(t),"OK"===t.data.status?(e.snackbar=!0,e.messageText="Lưu Nợ thành công !!!",e.color="success",o.daDongHocPhi=!1,o.daNo=!0):(e.snackbar=!0,e.messageText=t.data.message,e.color="error")}).catch(function(o){console.log(o),e.snackbar=!0,e.messageText="Lưu Nợ lỗi: "+o,e.color="error"})},async onLuuNhap(){let o=this;await axios({method:"post",url:"/HocPhi/LuuNhap_HocPhiAsync",data:{models:o.hocVienList}}).then(function(e){console.log(e),"OK"===e.data.status?(o.snackbar=!0,o.messageText="Lưu Bảng Tính thành công !!!",o.color="success"):(o.snackbar=!0,o.messageText=e.data.message,o.color="error")}).catch(function(e){console.log(e),o.snackbar=!0,o.messageText="Lưu Bảng Tính lỗi: "+e,o.color="error"})},async onUndo(o){let e=this;await axios.get("/HocPhi/UndoAsync?LopHocId="+this.selectedLopHoc.lopHocId+"&HocVienId="+o.hocVienId+"&Month="+this.selectedThang+"&Year="+this.selectedNam).then(function(t){"OK"===t.data.status?(e.snackbar=!0,e.messageText="Undo thành công !!!",e.color="success",o.daDongHocPhi=!1,o.daNo=!1):(e.snackbar=!0,e.messageText=t.data.message,e.color="error")}).catch(function(o){console.log(o),e.snackbar=!0,e.messageText="Undo lỗi: "+o,e.color="error"})}}});