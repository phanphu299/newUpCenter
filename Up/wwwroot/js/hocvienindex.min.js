var vue=new Vue({el:"#HocVienIndex",data:{title:"Quản Lý Học Viên",messageText:"",color:"",timeout:3e3,snackbar:!1,deleteDialog:!1,dialog:!1,dialogEdit:!1,dialogDiemDanh:!1,dialogNgayHoc:!1,dialogThemLop:!1,dialogImport:!1,alert:!1,alertEdit:!1,alertNgayHoc:!1,isShowDatePicker:!1,isShowDatePicker2:!1,isShowDatePickerBatDau:!1,isShowDatePickerKetThuc:!1,isShowDatePickerNgayHoc:!1,isShowDatePickerNgayHoc2:!1,search:"",newItem:{fullName:"",englishName:"",phone:"",otherPhone:"",facebookAccount:"",parentFullName:"",parentPhone:"",quanHe:"",lopHoc:"",isAppend:!1,ngaySinh:"",ngayHoc:""},selectedThang:"",selectedNam:"",itemThang:["1","2","3","4","5","6","7","8","9","10","11","12"],itemNam:[(new Date).toISOString().substr(0,4)-2,(new Date).toISOString().substr(0,4)-1,(new Date).toISOString().substr(0,4)-0],itemToDelete:{},itemToEdit:{},itemToDiemDanh:{},itemToNgayHoc:{},itemToThemLop:{},editedIndex:-1,headers:[{text:"Action",align:"left",sortable:!1,value:""},{text:"Họ Tên",value:"fullName",align:"left",sortable:!0},{text:"Lớp Học",value:"",align:"left",sortable:!1},{text:"Ngày Sinh",value:"ngaySinh",align:"left",sortable:!0},{text:"English Name",value:"englishName",align:"left",sortable:!0},{text:"SĐT",value:"phone",align:"left",sortable:!0},{text:"SĐT Khác",value:"otherPhone",align:"left",sortable:!0},{text:"Email",value:"facebookAccount",align:"left",sortable:!0},{text:"Họ Tên Phụ Huynh",value:"parentFullName",align:"left",sortable:!0},{text:"SĐT Phụ Huynh",value:"parentPhone",align:"left",sortable:!0},{text:"Quan Hệ",value:"quanHe",align:"left",sortable:!0},{text:"Ngày Tạo",value:"createdDate",align:"left",sortable:!0},{text:"Người Tạo",value:"createdBy",align:"left",sortable:!0},{text:"Ngày Sửa",value:"updatedDate",align:"left",sortable:!0},{text:"Người Sửa",value:"updatedBy",align:"left",sortable:!0}],khoaHocItems:[],diemDanhItems:[],ngayHocItem:{ngayBatDau:"",ngayKetThuc:""},itemQuanHe:[],itemLopHoc:[],itemDiemDanh:[],itemThemLop:[],itemNgayHoc:[],selectedLopHoc:{},selectedArrayLopHoc:[],soNgayHoc:[],arrayNgayHocLopHoc:[]},async beforeCreate(){let e=this;await axios.get("/HocVien/GetHocVienAsync").then(function(a){e.khoaHocItems=a.data}).catch(function(e){console.log(e.response.data.Message)}),await axios.get("/category/GetQuanHeAsync").then(function(a){e.itemQuanHe=a.data}).catch(function(e){console.log(e.response.data.Message)}),await axios.get("/LopHoc/GetAvailableLopHocAsync").then(function(a){e.itemLopHoc=a.data}).catch(function(e){console.log(e.response.data.Message)})},methods:{async onAddNgayHocLopHoc(){if(""!==this.newItem.ngayHoc&&""!==this.newItem.lopHoc){let e=!1;this.arrayNgayHocLopHoc.map(a=>{a.lopHoc.lopHocId===this.newItem.lopHoc.lopHocId&&(e=!0)}),!1===e&&this.arrayNgayHocLopHoc.push({lopHoc:this.newItem.lopHoc,ngayHoc:this.newItem.ngayHoc})}else this.snackbar=!0,this.messageText="Phải chọn cả ngày học và lớp học trước khi thêm !!!",this.color="error"},async onXoaNgayHocLopHoc(e){this.arrayNgayHocLopHoc=this.arrayNgayHocLopHoc.filter(a=>a.lopHoc.lopHocId!==e.lopHoc.lopHocId)},async onAddNgayHocLopHocForEdit(e){if(""!==this.itemToEdit.ngayHoc&&""!==this.itemToEdit.lopHoc){let a=!1;e.lopHoc_NgayHocList.map(e=>{e.lopHoc.lopHocId===this.itemToEdit.lopHoc.lopHocId&&(a=!0)}),!1===a&&e.lopHoc_NgayHocList.push({lopHoc:this.itemToEdit.lopHoc,ngayHoc:this.itemToEdit.ngayHoc})}else this.snackbar=!0,this.messageText="Phải chọn cả ngày học và lớp học trước khi thêm !!!",this.color="error"},async onXoaNgayHocLopHocForEdit(e){this.itemToEdit.lopHoc_NgayHocList=this.itemToEdit.lopHoc_NgayHocList.filter(a=>a.lopHoc.lopHocId!==e.lopHoc.lopHocId)},async onUpdate(e){let a=this;""===e.fullName?this.alertEdit=!0:0===e.lopHoc_NgayHocList.length?(this.snackbar=!0,this.messageText="Phải chọn lớp học và ngày học !!!",this.color="error"):await axios({method:"put",url:"/HocVien/UpdateHocVienAsync",data:{HocVienId:e.hocVienId,FullName:e.fullName,EnglishName:e.englishName,Phone:e.phone,OtherPhone:e.otherPhone,FacebookAccount:e.facebookAccount,ParentFullName:e.parentFullName,ParentPhone:e.parentPhone,QuanHeId:e.quanHeId,NgaySinh:e.ngaySinh,LopHocIds:e.lopHocIds,LopHoc_NgayHocList:e.lopHoc_NgayHocList}}).then(function(e){"OK"===e.data.status?(Object.assign(a.khoaHocItems[a.editedIndex],e.data.result),a.snackbar=!0,a.messageText=e.data.message,a.color="success",a.dialogEdit=!1):(a.snackbar=!0,a.messageText=e.data.message,a.color="error",a.dialogEdit=!1)}).catch(function(e){console.log(e.response.data.Message),a.snackbar=!0,a.messageText="Cập nhật lỗi: "+e.response.data.Message,a.color="error",a.dialogEdit=!1})},async onToggleAppend(e){let a=this;await axios({method:"put",url:"/HocVien/UpdateChenAsync",data:{HocVienId:e}}).then(function(e){"OK"===e.data.status?(a.snackbar=!0,a.messageText=e.data.message,a.color="success"):(a.snackbar=!0,a.messageText=e.data.message,a.color="error")}).catch(function(e){console.log(e),a.snackbar=!0,a.messageText="Cập nhật lỗi: "+e.response.data.Message,a.color="error"})},mappingEditItem(e){if(this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToEdit=Object.assign({},e),""!==this.itemToEdit.ngaySinh){let[e,a,t]=this.itemToEdit.ngaySinh.split("/");this.itemToEdit.ngaySinh=t+"-"+a+"-"+e}},mappingDiemDanhItem(e){this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToDiemDanh=Object.assign({},e);let a=this;axios.get("/LopHoc/GetLopHocByHocVienIdAsync?HocVienId="+e.hocVienId).then(function(e){a.itemDiemDanh=e.data}).catch(function(e){console.log(e.response.data.Message)})},mappingThemLopItem(e){this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToThemLop=Object.assign({},e);let a=this;axios.get("/LopHoc/GetGraduatedAndCanceledLopHocAsync").then(function(e){a.itemThemLop=e.data}).catch(function(e){console.log(e.response.data.Message)})},mappingNgayHocItem(e){this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToNgayHoc=Object.assign({},e),this.ngayHocItem.ngayBatDau="",this.ngayHocItem.ngayKetThuc="";let a=this;axios.get("/LopHoc/GetLopHocByHocVienIdAsync?HocVienId="+e.hocVienId).then(function(e){a.itemNgayHoc=e.data}).catch(function(e){console.log(e.response.data.Message)})},async onThemLop(e){this.dialogThemLop=!1;let a=this;await axios({method:"post",url:"/HocVien/AddHocVienToLopCuAsync",data:{LopHocId:a.selectedArrayLopHoc,HocVienId:e.hocVienId}}).then(function(e){"OK"===e.data.status?(a.snackbar=!0,a.messageText=e.data.message,a.color="success",a.selectedArrayLopHoc=[]):(a.snackbar=!0,a.messageText=e.data.message,a.color="error")}).catch(function(e){console.log(e.response.data.Message),a.snackbar=!0,a.messageText="Thêm mới lỗi: "+e.response.data.Message,a.color="error"})},async onThemNgayHoc(e){if(""!==this.ngayHocItem.ngayBatDau&&null!==this.selectedLopHoc){this.dialogNgayHoc=!1;let a=this;await axios({method:"post",url:"/HocVien/CreateUpdateHocVien_ngayHocAsync",data:{LopHocId:a.selectedLopHoc,HocVienId:e.hocVienId,NgayBatDau:a.ngayHocItem.ngayBatDau,NgayKetThuc:a.ngayHocItem.ngayKetThuc}}).then(function(e){"OK"===e.data.status?(a.snackbar=!0,a.messageText=e.data.message,a.color="success",a.selectedLopHoc=""):(a.snackbar=!0,a.messageText=e.data.message,a.color="error")}).catch(function(e){console.log(e.response.data.Message),a.snackbar=!0,a.messageText="Thêm mới lỗi: "+e.response.data.Message,a.color="error"})}else this.alertNgayHoc=!0},async onSave(e){if(""===this.newItem.fullName)this.alert=!0;else if(0===this.arrayNgayHocLopHoc.length)this.snackbar=!0,this.messageText="Phải chọn lớp học và ngày học !!!",this.color="error";else{this.dialog=!1;let e=this;await axios({method:"post",url:"/HocVien/CreateHocVienAsync",data:{FullName:e.newItem.fullName,EnglishName:e.newItem.englishName,Phone:e.newItem.phone,OtherPhone:e.newItem.otherPhone,FacebookAccount:e.newItem.facebookAccount,NgaySinh:e.newItem.ngaySinh,ParentFullName:e.newItem.parentFullName,ParentPhone:e.newItem.parentPhone,QuanHeId:e.newItem.quanHe,LopHoc_NgayHocList:e.arrayNgayHocLopHoc}}).then(function(a){"OK"===a.data.status?(e.khoaHocItems.splice(0,0,a.data.result),e.snackbar=!0,e.messageText=a.data.message,e.color="success",e.newItem.fullName="",e.newItem.englishName="",e.newItem.phone="",e.newItem.otherPhone="",e.newItem.facebookAccount="",e.newItem.ngaySinh="",e.newItem.parentFullName="",e.newItem.quanHe="",e.newItem.lopHoc=[]):(e.snackbar=!0,e.messageText=a.data.message,e.color="error")}).catch(function(a){console.log(a.response.data.Message),e.snackbar=!0,e.messageText="Thêm mới lỗi: "+a.response.data.Message,e.color="error"})}},async onDelete(e){let a=this;await axios({method:"delete",url:"/HocVien/DeleteHocVienAsync",data:{HocVienId:e.hocVienId}}).then(function(t){"OK"===t.data.status?(a.khoaHocItems.splice(a.khoaHocItems.indexOf(e),1),a.snackbar=!0,a.messageText=t.data.message,a.color="success",a.deleteDialog=!1):(a.snackbar=!0,a.messageText=t.data.message,a.color="error")}).catch(function(e){console.log(e.response.data.Message),a.snackbar=!0,a.messageText="Xóa lỗi: "+e.response.data.Message,a.color="error"})},async GetDiemDanhByHocVien(){let e=this;""!==this.selectedLopHoc&&""!==this.selectedNam&&""!==this.selectedThang&&(await axios.get("/DiemDanh/GetDiemDanhByHocVienAndLopHocAsync?HocVienId="+e.itemToDiemDanh.hocVienId+"&LopHocId="+e.selectedLopHoc+"&month="+e.selectedThang+"&year="+e.selectedNam).then(function(a){e.diemDanhItems=a.data}).catch(function(e){console.log(e.response.data.Message)}),await axios.get("/DiemDanh/GetSoNgayHoc?LopHocId="+e.selectedLopHoc+"&month="+e.selectedThang+"&year="+e.selectedNam).then(function(a){e.soNgayHoc=a.data}).catch(function(e){console.log(e.response.data.Message)}))},forceFileDownload(e,a){const t=window.URL.createObjectURL(new Blob([e.data])),o=document.createElement("a");o.href=t,o.setAttribute("download",a+".xlsx"),document.body.appendChild(o),o.click()},async onExportTemplate(){let e=this;await axios({url:"/HocVien/ExportTemplate?LopHocId="+e.selectedLopHoc,method:"get",responseType:"blob"}).then(function(a){e.forceFileDownload(a,"MauImportHocVien")}).catch(function(e){console.log(e.response.data.Message)})},async onImport(){let e=this;if(!e.$refs.myFiles.files.length)return e.snackbar=!0,e.messageText="Phải chọn file để import !!!",void(e.color="error");const a=new FileReader;a.readAsDataURL(e.$refs.myFiles.files[0]),a.addEventListener("load",()=>{axios({url:"/HocVien/Import",method:"post",data:{File:a.result,Name:e.$refs.myFiles.files[0].name}}).then(function(a){if("OK"===a.data.status){for(let t=0;t<a.data.result.length;t++)e.khoaHocItems.splice(0,0,a.data.result[t]);e.snackbar=!0,e.messageText=a.data.message,e.color="success",e.dialogImport=!1}else e.snackbar=!0,e.messageText=a.data.message,e.color="error"}).catch(function(a){console.log(a.response.data.Message),e.snackbar=!0,e.messageText="Import lỗi: "+a.response.data.Message,e.color="error"})})},async GetNgayHocByHocVien(){let e=this;await axios.get("/HocVien/GetHocVien_LopHocByHocVienAsync?HocVienId="+e.itemToNgayHoc.hocVienId+"&LopHocId="+e.selectedLopHoc).then(function(a){if(null!==a.data){e.ngayHocItem=a.data;let[t,o,s]=e.ngayHocItem.ngayBatDau.split("/");if(e.ngayHocItem.ngayBatDau=s+"-"+o+"-"+t,""!==e.ngayHocItem.ngayKetThuc){let[a,t,o]=e.ngayHocItem.ngayKetThuc.split("/");e.ngayHocItem.ngayKetThuc=o+"-"+t+"-"+a}}else this.ngayHocItem.ngayBatDau="",this.ngayHocItem.ngayKetThuc=""}).catch(function(e){console.log(e.response.data.Message)})}}});