var vue=new Vue({el:"#HocVienIndex",data:{title:"Quản Lý Học Viên",messageText:"",color:"",timeout:3e3,snackbar:!1,deleteDialog:!1,dialog:!1,dialogEdit:!1,dialogDiemDanh:!1,dialogNgayHoc:!1,dialogThemLop:!1,dialogImport:!1,alert:!1,alertEdit:!1,alertNgayHoc:!1,isShowDatePicker:!1,isShowDatePicker2:!1,isShowDatePickerBatDau:!1,isShowDatePickerKetThuc:!1,isShowDatePickerNgayHoc:!1,isShowDatePickerNgayHoc2:!1,search:"",newItem:{fullName:"",englishName:"",phone:"",otherPhone:"",facebookAccount:"",parentFullName:"",parentPhone:"",quanHe:"",lopHoc:"",isAppend:!1,ngaySinh:"",ngayHoc:""},selectedThang:"",selectedNam:"",itemThang:["1","2","3","4","5","6","7","8","9","10","11","12"],itemNam:[(new Date).toISOString().substr(0,4)-2,(new Date).toISOString().substr(0,4)-1,(new Date).toISOString().substr(0,4)-0],itemToDelete:{},itemToEdit:{},itemToDiemDanh:{},itemToNgayHoc:{},itemToThemLop:{},editedIndex:-1,headers:[{text:"Action",align:"left",sortable:!1,value:""},{text:"Họ Tên",value:"fullName",align:"left",sortable:!0},{text:"Lớp Học",value:"",align:"left",sortable:!1},{text:"Ngày Sinh",value:"ngaySinh",align:"left",sortable:!0},{text:"English Name",value:"englishName",align:"left",sortable:!0},{text:"SĐT",value:"phone",align:"left",sortable:!0},{text:"SĐT Khác",value:"otherPhone",align:"left",sortable:!0},{text:"Facebook",value:"facebookAccount",align:"left",sortable:!0},{text:"Họ Tên Phụ Huynh",value:"parentFullName",align:"left",sortable:!0},{text:"SĐT Phụ Huynh",value:"parentPhone",align:"left",sortable:!0},{text:"Quan Hệ",value:"quanHe",align:"left",sortable:!0},{text:"Ngày Tạo",value:"createdDate",align:"left",sortable:!0},{text:"Người Tạo",value:"createdBy",align:"left",sortable:!0},{text:"Ngày Sửa",value:"updatedDate",align:"left",sortable:!0},{text:"Người Sửa",value:"updatedBy",align:"left",sortable:!0}],khoaHocItems:[],diemDanhItems:[],ngayHocItem:{ngayBatDau:"",ngayKetThuc:""},itemQuanHe:[],itemLopHoc:[],itemDiemDanh:[],itemThemLop:[],itemNgayHoc:[],selectedLopHoc:{},selectedArrayLopHoc:[],soNgayHoc:[],arrayNgayHocLopHoc:[]},async beforeCreate(){let e=this;await axios.get("/HocVien/GetHocVienAsync").then(function(t){e.khoaHocItems=t.data}).catch(function(e){console.log(e)}),await axios.get("/category/GetQuanHeAsync").then(function(t){e.itemQuanHe=t.data}).catch(function(e){console.log(e)}),await axios.get("/LopHoc/GetAvailableLopHocAsync").then(function(t){e.itemLopHoc=t.data}).catch(function(e){console.log(e)})},methods:{async onAddNgayHocLopHoc(){if(""!==this.newItem.ngayHoc&&""!==this.newItem.lopHoc){let e=!1;this.arrayNgayHocLopHoc.map(t=>{t.lopHoc.lopHocId===this.newItem.lopHoc.lopHocId&&(e=!0)}),!1===e&&this.arrayNgayHocLopHoc.push({lopHoc:this.newItem.lopHoc,ngayHoc:this.newItem.ngayHoc})}else this.snackbar=!0,this.messageText="Phải chọn cả ngày học và lớp học trước khi thêm !!!",this.color="error"},async onXoaNgayHocLopHoc(e){this.arrayNgayHocLopHoc=this.arrayNgayHocLopHoc.filter(t=>t.lopHoc.lopHocId!==e.lopHoc.lopHocId)},async onAddNgayHocLopHocForEdit(e){if(""!==this.itemToEdit.ngayHoc&&""!==this.itemToEdit.lopHoc){let t=!1;e.lopHoc_NgayHocList.map(e=>{e.lopHoc.lopHocId===this.itemToEdit.lopHoc.lopHocId&&(t=!0)}),!1===t&&e.lopHoc_NgayHocList.push({lopHoc:this.itemToEdit.lopHoc,ngayHoc:this.itemToEdit.ngayHoc})}else this.snackbar=!0,this.messageText="Phải chọn cả ngày học và lớp học trước khi thêm !!!",this.color="error"},async onXoaNgayHocLopHocForEdit(e){this.itemToEdit.lopHoc_NgayHocList=this.itemToEdit.lopHoc_NgayHocList.filter(t=>t.lopHoc.lopHocId!==e.lopHoc.lopHocId)},async onUpdate(e){let t=this;""===e.fullName?this.alertEdit=!0:0===e.lopHoc_NgayHocList.length?(this.snackbar=!0,this.messageText="Phải chọn lớp học và ngày học !!!",this.color="error"):await axios({method:"put",url:"/HocVien/UpdateHocVienAsync",data:{HocVienId:e.hocVienId,FullName:e.fullName,EnglishName:e.englishName,Phone:e.phone,OtherPhone:e.otherPhone,FacebookAccount:e.facebookAccount,ParentFullName:e.parentFullName,ParentPhone:e.parentPhone,QuanHeId:e.quanHeId,NgaySinh:e.ngaySinh,LopHocIds:e.lopHocIds,LopHoc_NgayHocList:e.lopHoc_NgayHocList}}).then(function(e){"OK"===e.data.status?(Object.assign(t.khoaHocItems[t.editedIndex],e.data.result),t.snackbar=!0,t.messageText="Cập nhật thành công !!!",t.color="success",t.dialogEdit=!1):(t.snackbar=!0,t.messageText=e.data.message,t.color="error",t.dialogEdit=!1)}).catch(function(e){console.log(e),t.snackbar=!0,t.messageText="Cập nhật lỗi: "+e,t.color="error",t.dialogEdit=!1})},async onToggleAppend(e){let t=this;await axios({method:"put",url:"/HocVien/UpdateChenAsync",data:{HocVienId:e}}).then(function(e){"OK"===e.data.status?(t.snackbar=!0,t.messageText="Cập nhật thành công !!!",t.color="success"):(t.snackbar=!0,t.messageText=e.data.message,t.color="error")}).catch(function(e){console.log(e),t.snackbar=!0,t.messageText="Cập nhật lỗi: "+e,t.color="error"})},mappingEditItem(e){if(this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToEdit=Object.assign({},e),""!==this.itemToEdit.ngaySinh){let[e,t,o]=this.itemToEdit.ngaySinh.split("/");this.itemToEdit.ngaySinh=o+"-"+t+"-"+e}},mappingDiemDanhItem(e){this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToDiemDanh=Object.assign({},e);let t=this;axios.get("/LopHoc/GetLopHocByHocVienIdAsync?HocVienId="+e.hocVienId).then(function(e){t.itemDiemDanh=e.data}).catch(function(e){console.log(e)})},mappingThemLopItem(e){this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToThemLop=Object.assign({},e);let t=this;axios.get("/LopHoc/GetGraduatedAndCanceledLopHocAsync").then(function(e){t.itemThemLop=e.data}).catch(function(e){console.log(e)})},mappingNgayHocItem(e){this.editedIndex=this.khoaHocItems.indexOf(e),this.itemToNgayHoc=Object.assign({},e),this.ngayHocItem.ngayBatDau="",this.ngayHocItem.ngayKetThuc="";let t=this;axios.get("/LopHoc/GetLopHocByHocVienIdAsync?HocVienId="+e.hocVienId).then(function(e){t.itemNgayHoc=e.data}).catch(function(e){console.log(e)})},async onThemLop(e){this.dialogThemLop=!1;let t=this;await axios({method:"post",url:"/HocVien/AddHocVienToLopCuAsync",data:{LopHocId:t.selectedArrayLopHoc,HocVienId:e.hocVienId}}).then(function(e){console.log(e),"OK"===e.data.status?(t.snackbar=!0,t.messageText="Thêm mới thành công !!!",t.color="success",t.selectedArrayLopHoc=[]):(t.snackbar=!0,t.messageText=e.data.message,t.color="error")}).catch(function(e){console.log(e),t.snackbar=!0,t.messageText="Thêm mới lỗi: "+e,t.color="error"})},async onThemNgayHoc(e){if(""!==this.ngayHocItem.ngayBatDau&&null!==this.selectedLopHoc){this.dialogNgayHoc=!1;let t=this;await axios({method:"post",url:"/HocVien/CreateUpdateHocVien_ngayHocAsync",data:{LopHocId:t.selectedLopHoc,HocVienId:e.hocVienId,NgayBatDau:t.ngayHocItem.ngayBatDau,NgayKetThuc:t.ngayHocItem.ngayKetThuc}}).then(function(e){console.log(e),"OK"===e.data.status?(t.snackbar=!0,t.messageText="Thêm mới thành công !!!",t.color="success",t.selectedLopHoc=""):(t.snackbar=!0,t.messageText=e.data.message,t.color="error")}).catch(function(e){console.log(e),t.snackbar=!0,t.messageText="Thêm mới lỗi: "+e,t.color="error"})}else this.alertNgayHoc=!0},async onSave(e){if(""===this.newItem.fullName)this.alert=!0;else if(0===this.arrayNgayHocLopHoc.length)this.snackbar=!0,this.messageText="Phải chọn lớp học và ngày học !!!",this.color="error";else{this.dialog=!1;let e=this;await axios({method:"post",url:"/HocVien/CreateHocVienAsync",data:{FullName:e.newItem.fullName,EnglishName:e.newItem.englishName,Phone:e.newItem.phone,OtherPhone:e.newItem.otherPhone,FacebookAccount:e.newItem.facebookAccount,NgaySinh:e.newItem.ngaySinh,ParentFullName:e.newItem.parentFullName,ParentPhone:e.newItem.parentPhone,QuanHeId:e.newItem.quanHe,LopHoc_NgayHocList:e.arrayNgayHocLopHoc}}).then(function(t){console.log(t),"OK"===t.data.status?(e.khoaHocItems.splice(0,0,t.data.result),e.snackbar=!0,e.messageText="Thêm mới thành công !!!",e.color="success",e.newItem.fullName="",e.newItem.englishName="",e.newItem.phone="",e.newItem.otherPhone="",e.newItem.facebookAccount="",e.newItem.ngaySinh="",e.newItem.parentFullName="",e.newItem.quanHe="",e.newItem.lopHoc=[]):(e.snackbar=!0,e.messageText=t.data.message,e.color="error")}).catch(function(t){console.log(t),e.snackbar=!0,e.messageText="Thêm mới lỗi: "+t,e.color="error"})}},async onDelete(e){let t=this;await axios({method:"delete",url:"/HocVien/DeleteHocVienAsync",data:{HocVienId:e.hocVienId}}).then(function(o){"OK"===o.data.status?(t.khoaHocItems.splice(t.khoaHocItems.indexOf(e),1),t.snackbar=!0,t.messageText="Xóa thành công !!!",t.color="success",t.deleteDialog=!1):(t.snackbar=!0,t.messageText=o.data.message,t.color="error")}).catch(function(e){console.log(e),t.snackbar=!0,t.messageText="Xóa lỗi: "+e,t.color="error"})},async GetDiemDanhByHocVien(){let e=this;""!==this.selectedLopHoc&&""!==this.selectedNam&&""!==this.selectedThang&&(await axios.get("/DiemDanh/GetDiemDanhByHocVienAndLopHocAsync?HocVienId="+e.itemToDiemDanh.hocVienId+"&LopHocId="+e.selectedLopHoc+"&month="+e.selectedThang+"&year="+e.selectedNam).then(function(t){e.diemDanhItems=t.data}).catch(function(e){console.log(e)}),await axios.get("/DiemDanh/GetSoNgayHoc?LopHocId="+e.selectedLopHoc+"&month="+e.selectedThang+"&year="+e.selectedNam).then(function(t){e.soNgayHoc=t.data}).catch(function(e){console.log(e)}))},forceFileDownload(e,t){const o=window.URL.createObjectURL(new Blob([e.data])),a=document.createElement("a");a.href=o,a.setAttribute("download",t+".xlsx"),document.body.appendChild(a),a.click()},async onExportTemplate(){let e=this;await axios({url:"/HocVien/ExportTemplate?LopHocId="+e.selectedLopHoc,method:"get",responseType:"blob"}).then(function(t){e.forceFileDownload(t,"MauImportHocVien")}).catch(function(e){console.log(e)})},async onImport(){let e=this;if(!e.$refs.myFiles.files.length)return e.snackbar=!0,e.messageText="Phải chọn file để import !!!",void(e.color="error");const t=new FileReader;t.readAsDataURL(e.$refs.myFiles.files[0]),t.addEventListener("load",()=>{axios({url:"/HocVien/Import",method:"post",data:{File:t.result,Name:e.$refs.myFiles.files[0].name}}).then(function(t){if("OK"===t.data.status){for(let o=0;o<t.data.result.length;o++)e.khoaHocItems.splice(0,0,t.data.result[o]);e.snackbar=!0,e.messageText=t.data.message,e.color="success",e.dialogImport=!1}else e.snackbar=!0,e.messageText=t.data.message,e.color="error"}).catch(function(t){console.log(t),e.snackbar=!0,e.messageText="Import lỗi: "+t,e.color="error"})})},async GetNgayHocByHocVien(){let e=this;await axios.get("/HocVien/GetHocVien_LopHocByHocVienAsync?HocVienId="+e.itemToNgayHoc.hocVienId+"&LopHocId="+e.selectedLopHoc).then(function(t){if(null!==t.data){e.ngayHocItem=t.data;let[o,a,c]=e.ngayHocItem.ngayBatDau.split("/");if(e.ngayHocItem.ngayBatDau=c+"-"+a+"-"+o,""!==e.ngayHocItem.ngayKetThuc){let[t,o,a]=e.ngayHocItem.ngayKetThuc.split("/");e.ngayHocItem.ngayKetThuc=a+"-"+o+"-"+t}}else this.ngayHocItem.ngayBatDau="",this.ngayHocItem.ngayKetThuc=""}).catch(function(e){console.log(e)})}}});